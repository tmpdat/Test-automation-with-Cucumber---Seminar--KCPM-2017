/**
 * Created by Anatolij on 28.12.2015.
 */
var _fs = require('fs'),
	_path = require('path'),
	_os = require('os'),
	_extend = require('util')._extend;

module.exports = new (function () {
	this.path = null;

	var _searchFor = ['firefox.exe', 'firefox'];

	var _env = function(key) {
		for(var i in process.env) {
			if (key.toUpperCase() == i.toUpperCase()) return process.env[i];
		}
		return null;
	};

	var _getExePath = function() {
		var path = _env('PATH'),
			pathArr = path.split(_os.platform() == 'win32' ? ';' : ':'),
			p = '',
			chkPath = null,
			pf = null;

		pf += _path.normalize(_env('PROGRAMFILES')+_path.sep+'Mozilla Firefox');
		if (pf) pathArr.unshift(pf);

		pf = _path.normalize(_env('PROGRAMFILES(X86)')+_path.sep+'Mozilla Firefox');
		if (pf) pathArr.unshift(pf);

		// im PATH suchen
		while(pathArr.length > 0) {
			p = _path.normalize(pathArr.shift().trim()+_path.sep);
			for(var e=0; e < _searchFor.length; e++) {
				chkPath = p+_searchFor[e];
				try {
					var Stat = _fs.statSync(chkPath);
					if (Stat) {
						if (Stat.isFile()) {
							return chkPath;
						}
					}
				} catch (e) { }
			}
		}

		return null;
	};

	this.path = _getExePath();

	this.open = function(url, options, cb) {
		if (!this.path) cb(new Error("Firefox not found"), null);
		var xulPath, firefox;

		options = _extend({
			width: 250
			, height: 250
			, url: url
		}, options ? options : {});

		xulPath = __dirname+_path.sep+'lib'+_path.sep+'node-firefox-driver.ini';
		var arguments = ['-app', xulPath];
		for (var i in options) {
			arguments.push('-'+i);
			arguments.push(options[i]);
		}
		firefox = require('child_process').spawn(this.path, arguments);
		console.info(this.path+' '+arguments.join(' '));
		/*_createApp(function(err, path) {

		});*/
		cb(null, firefox);
	};
})();